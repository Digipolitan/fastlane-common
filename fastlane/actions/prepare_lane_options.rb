require_relative 'models/bind_param'

module Fastlane
  module Actions
    module SharedValues
    end

    class PrepareLaneOptionsAction < Action
      def self.run(params)
        options = params[:options]
        bind_params = params[:bind_params]
        bind_params.each { |param|
          name = param.name
          if options[name] == nil
            if value = param.value
              options[name] = value
            elsif param.optional == false
              error_msg = "Missing required lane option '#{name}'"
              if env_var = param.env_var
                error_msg << " or environment variable '#{env_var}'"
              end
              if lane_context = param.lane_context
                error_msg << " or lane context '#{lane_context}'"
              end
              UI.user_error! error_msg
            end
          end
        }
      end

      #####################################################
      # @!group Documentation
      #####################################################

      def self.description
        "Fill env_var, lane_context or default_value with key inside the input lane options and ckeck required keys"
      end

      def self.available_options
        [
          FastlaneCore::ConfigItem.new(key: :options,
                                       description: "inout lane Hash options, will be fill by the mapping",
                                       is_string: false,
                                       optional: false),
          FastlaneCore::ConfigItem.new(key: :bind_params,
                                       description: "Array of BindParam",
                                       is_string: false,
                                       optional: false)
        ]
      end

      def self.authors
        ["bbriatte"]
      end

      def self.is_supported?(platform)
        true
      end

      def self.example_code
        [
          'prepare_lane_options(
            options: lane_options,
            bind_params: [
              Actions::BindParam.optional(:product_name, nil, "PRODUCT_NAME"),
              Actions::BindParam.optional(:github_release_link, SharedValues::SET_GITHUB_RELEASE_HTML_LINK)
            ]
          )',
          'prepare_lane_options(
            options: lane_options,
            bind_params: [
              Actions::BindParam.required(:product_name, nil, "PRODUCT_NAME"),
              Actions::BindParam.optional(:changelog, nil, "CHANGELOG_CONTENT", "Empty changelog")
            ]
          )'
        ]
      end

      def self.category
        :misc
      end
    end
  end
end
